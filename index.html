<!DOCTYPE html>
<html>
<head>
    <title>Шутер от первого лица (Мобильный)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #1a2a1a; 
            touch-action: none; /* Отключаем стандартные жесты браузера */
        }
        canvas { 
            display: block; 
            width: 100vw; 
            height: 100vh; 
        }
        #menu, #tasks, #shop { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(34, 51, 34, 0.85); 
            color: #b8c2b8; 
            font-family: 'Impact', Arial, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            z-index: 10; 
        }
        #menu button, #tasks button, #shop button { 
            padding: 10px 20px; 
            margin: 8px; 
            font-size: 18px; 
            background: linear-gradient(45deg, #3c4f3c, #2a3b2a); 
            color: #b8c2b8; 
            border: 1px solid #4b704b; 
            border-radius: 4px; 
            cursor: pointer; 
            text-transform: uppercase; 
            transition: transform 0.1s, background 0.2s; 
        }
        #menu button:active, #tasks button:active, #shop button:active { 
            transform: scale(0.95); 
            background: linear-gradient(45deg, #4b704b, #3c4f3c); 
        }
        #tasks div, #shop div { 
            max-height: 60%; 
            overflow-y: auto; 
            width: 80%; 
            font-size: 16px; 
            padding: 8px; 
            background: #2a3b2a; 
            border: 1px solid #4b704b; 
            border-radius: 4px; 
        }
        #score { 
            position: absolute; 
            top: 5px; 
            left: 5px; 
            color: #b8c2b8; 
            font-size: 16px; 
            font-family: 'Impact', Arial, sans-serif; 
            text-shadow: 1px 1px 2px #000; 
        }
        #health { 
            position: absolute; 
            top: 25px; 
            left: 5px; 
            color: #b8c2b8; 
            font-size: 16px; 
            font-family: 'Impact', Arial, sans-serif; 
            text-shadow: 1px 1px 2px #000; 
        }
        #crosshair { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            color: #b8c2b8; 
            font-size: 20px; 
            text-shadow: 1px 1px 2px #000; 
        }
        #shootBtn { 
            position: absolute; 
            bottom: 15px; 
            right: 15px; 
            width: 50px; 
            height: 50px; 
            background: linear-gradient(45deg, #ff3333, #cc0000); 
            border: 1px solid #4b704b; 
            border-radius: 50%; 
            color: #b8c2b8; 
            font-size: 14px; 
            font-family: 'Impact', Arial, sans-serif; 
            text-transform: uppercase; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: transform 0.1s; 
        }
        #shootBtn:active { 
            transform: scale(0.9); 
        }
        #gameOver { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(34, 51, 34, 0.9); 
            color: #b8c2b8; 
            font-family: 'Impact', Arial, sans-serif; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 10; 
        }
        /* Горизонтальная ориентация */
        @media (orientation: portrait) {
            body::before {
                content: "Поверните устройство горизонтально";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #1a2a1a;
                color: #b8c2b8;
                font-family: 'Impact', Arial, sans-serif;
                font-size: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                z-index: 1000;
            }
            canvas, #menu, #tasks, #shop, #score, #health, #crosshair, #shootBtn, #gameOver { display: none; }
        }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Операция: Шторм</h1>
        <button onclick="startGame('day')">Играть (День)</button>
        <button onclick="startGame('night')">Играть (Ночь)</button>
        <button onclick="showTasks()">Задания</button>
        <button onclick="showShop()">Магазин</button>
    </div>
    <div id="tasks" style="display: none;">
        <h1>Задания</h1>
        <div>
            <p>1. Убить 10 врагов (Награда: 50 очков)</p>
            <p>2. Набрать 100 очков (Награда: 100 очков)</p>
            <p>3. Выжить 1 минуту (Награда: 200 очков)</p>
            <p>4. Убить 5 врагов за 30 секунд (Награда: 150 очков)</p>
            <p>5. Достигнуть 500 очков (Награда: 300 очков)</p>
            <p>6. Убить 20 врагов (Награда: 100 очков)</p>
            <p>7. Выжить без урона 30 секунд (Награда: 200 очков)</p>
            <p>8. Убить врага с 20 метров (Награда: 150 очков)</p>
            <p>9. Набрать 1000 очков (Награда: 500 очков)</p>
            <p>10. Убить 3 врагов подряд (Награда: 100 очков)</p>
            <p>11. Выжить 2 минуты (Награда: 400 очков)</p>
            <p>12. Убить 50 врагов (Награда: 300 очков)</p>
            <p>13. Набрать 200 очков за 1 минуту (Награда: 250 очков)</p>
            <p>14. Убить 10 врагов без урона (Награда: 200 очков)</p>
            <p>15. Достигнуть 2000 очков (Награда: 1000 очков)</p>
            <p>16. Убить врага с 30 метров (Награда: 200 очков)</p>
            <p>17. Выжить 3 минуты (Награда: 600 очков)</p>
            <p>18. Убить 5 врагов за 20 секунд (Награда: 200 очков)</p>
            <p>19. Набрать 500 очков без урона (Награда: 400 очков)</p>
            <p>20. Убить 100 врагов (Награда: 1000 очков)</p>
        </div>
        <button onclick="showMenu()">Назад</button>
    </div>
    <div id="shop" style="display: none;">
        <h1>Магазин</h1>
        <div>
            <p>Доп. здоровье (+50 HP) - 100 очков <button onclick="buyHealth()">Купить</button></p>
            <p>Регенерация (+1 HP/сек) - 200 очков <button onclick="buyRegen()">Купить</button></p>
            <p>Увеличенный урон (+50%) - 150 очков <button onclick="buyDamage()">Купить</button></p>
        </div>
        <button onclick="showMenu()">Назад</button>
    </div>
    <div id="score" style="display: none;">Очки: 0</div>
    <div id="health" style="display: none;">Здоровье: 100</div>
    <div id="crosshair" style="display: none;">+</div>
    <button id="shootBtn" style="display: none;">Огонь</button>
    <div id="gameOver" style="display: none;">
        <h1>Миссия провалена</h1>
        <button onclick="showMenu()">Вернуться в меню</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.10.0/dist/nipplejs.min.js"></script>
    <script>
        // Зафиксировать горизонтальную ориентацию
        if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('landscape').catch(() => {});
        }

        // Сцена, камера, рендер
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Оптимизация для retina-экранов
        document.body.appendChild(renderer.domElement);

        // Пол
        const groundGeometry = new THREE.PlaneGeometry(100, 100);
        const groundMaterial = new THREE.MeshBasicMaterial({ color: 0x2a3b2a });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // Освещение
        let ambientLight, spotLight;
        function setTimeOfDay(time) {
            scene.remove(ambientLight, spotLight);
            if (time === 'day') {
                ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                scene.add(ambientLight);
            } else {
                ambientLight = new THREE.AmbientLight(0x222222, 0.2);
                spotLight = new THREE.SpotLight(0xffffff, 0.5);
                spotLight.position.set(0, 1.6, 0);
                spotLight.angle = Math.PI / 6;
                spotLight.penumbra = 0.5;
                spotLight.distance = 20;
                scene.add(ambientLight, spotLight);
            }
        }

        // Оружие (два прямоугольника с анимацией)
        const weaponGeometry = new THREE.BoxGeometry(0.15, 0.08, 0.4);
        const weaponMaterial = new THREE.MeshBasicMaterial({ color: 0x4b704b });
        const weaponLeft = new THREE.Mesh(weaponGeometry, weaponMaterial);
        const weaponRight = new THREE.Mesh(weaponGeometry, weaponMaterial);
        weaponLeft.position.set(-0.3, -0.25, -0.5);
        weaponRight.position.set(0.3, -0.25, -0.5);
        camera.add(weaponLeft, weaponRight);
        scene.add(camera);

        // Игрок
        camera.position.y = 1.6;
        let moveSpeed = 0.12; // Плавное движение
        let yaw = 0;
        let health = 100;
        let regenRate = 0;
        let damageMultiplier = 1;
        let score = 0;

        // Управление
        let moveJoystick, touchZone;
        function setupControls() {
            // Джойстик для движения
            moveJoystick = nipplejs.create({
                zone: document.body,
                position: { left: '10%', bottom: '10%' },
                mode: 'static',
                size: 80, // Уменьшенный размер
                color: 'white',
                threshold: 0.2, // Мёртвая зона
                fadeTime: 0,
                restOpacity: 0.7
            });
            moveJoystick.on('move', (evt, data) => {
                if (data.force < 0.2) return; // Игнорируем слабые касания
                const direction = new THREE.Vector3();
                camera.getWorldDirection(direction);
                direction.y = 0;
                direction.normalize();
                const angle = data.angle.radian;
                const force = Math.min(data.force, 1);
                const move = direction.clone().applyAxisAngle(new THREE.Vector3(0, 1, 0), angle).multiplyScalar(force * moveSpeed);
                camera.position.add(move);
            });

            // Зона свайпа для поворота
            touchZone = document.createElement('div');
            touchZone.style.position = 'absolute';
            touchZone.style.right = '0';
            touchZone.style.top = '0';
            touchZone.style.width = '50%';
            touchZone.style.height = '100%';
            document.body.appendChild(touchZone);
            let touchStartX = null;
            let lastDeltaX = 0;
            touchZone.addEventListener('touchstart', (e) => {
                e.preventDefault();
                touchStartX = e.touches[0].clientX;
            });
            touchZone.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (touchStartX !== null) {
                    const deltaX = e.touches[0].clientX - touchStartX;
                    const smoothedDelta = lastDeltaX * 0.7 + deltaX * 0.3; // Сглаживание
                    yaw -= smoothedDelta * 0.003; // Уменьшена чувствительность
                    camera.rotation.set(0, yaw, 0);
                    touchStartX = e.touches[0].clientX;
                    lastDeltaX = deltaX;
                }
            });
            touchZone.addEventListener('touchend', () => {
                touchStartX = null;
                lastDeltaX = 0;
            });
        }

        // Враги
        const enemies = [];
        function spawnEnemy() {
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshBasicMaterial({ color: 0x8b0000 });
            const enemy = new THREE.Mesh(geometry, material);
            const angle = Math.random() * Math.PI * 2;
            const distance = 20;
            enemy.position.set(Math.cos(angle) * distance, 0.5, Math.sin(angle) * distance);
            scene.add(enemy);
            enemies.push(enemy);
        }

        // Пули
        const bullets = [];
        let lastShot = 0;
        function shoot() {
            const now = performance.now();
            if (now - lastShot < 200) return; // Ограничение скорострельности (5 выстрелов/сек)
            lastShot = now;
            const geometry = new THREE.SphereGeometry(0.08, 8, 8);
            const material = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const bullet = new THREE.Mesh(geometry, material);
            bullet.position.copy(camera.position);
            const direction = new THREE.Vector3();
            camera.getWorldDirection(direction);
            bullet.velocity = direction.multiplyScalar(0.6);
            scene.add(bullet);
            bullets.push(bullet);
            // Анимация оружия
            weaponLeft.position.z -= 0.1;
            weaponRight.position.z -= 0.1;
            setTimeout(() => {
                weaponLeft.position.z += 0.1;
                weaponRight.position.z += 0.1;
            }, 100);
        }

        document.getElementById('shootBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            shoot();
        });

        // UI элементы
        const scoreElement = document.getElementById('score');
        const healthElement = document.getElementById('health');
        const gameOverElement = document.getElementById('gameOver');

        // Меню
        function showMenu() {
            document.getElementById('menu').style.display = 'flex';
            document.getElementById('tasks').style.display = 'none';
            document.getElementById('shop').style.display = 'none';
            document.getElementById('score').style.display = 'none';
            document.getElementById('health').style.display = 'none';
            document.getElementById('crosshair').style.display = 'none';
            document.getElementById('shootBtn').style.display = 'none';
            gameOverElement.style.display = 'none';
            if (moveJoystick) moveJoystick.destroy();
            if (touchZone) touchZone.remove();
            enemies.forEach(enemy => scene.remove(enemy));
            enemies.length = 0;
            bullets.forEach(bullet => scene.remove(bullet));
            bullets.length = 0;
            if (ambientLight) scene.remove(ambientLight);
            if (spotLight) scene.remove(spotLight);
        }

        function showTasks() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('tasks').style.display = 'flex';
        }

        function showShop() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('shop').style.display = 'flex';
        }

        function startGame(time) {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('score').style.display = 'block';
            document.getElementById('health').style.display = 'block';
            document.getElementById('crosshair').style.display = 'block';
            document.getElementById('shootBtn').style.display = 'block';
            gameOverElement.style.display = 'none';
            health = 100;
            score = 0;
            scoreElement.textContent = `Очки: ${score}`;
            healthElement.textContent = `Здоровье: ${health}`;
            setTimeOfDay(time);
            setupControls();
            setInterval(spawnEnemy, 2000);
            animate();
        }

        // Магазин
        function buyHealth() {
            if (score >= 100) {
                score -= 100;
                health += 50;
                scoreElement.textContent = `Очки: ${score}`;
                healthElement.textContent = `Здоровье: ${health}`;
            }
        }

        function buyRegen() {
            if (score >= 200) {
                score -= 200;
                regenRate = 1;
                scoreElement.textContent = `Очки: ${score}`;
            }
        }

        function buyDamage() {
            if (score >= 150) {
                score -= 150;
                damageMultiplier = 1.5;
                scoreElement.textContent = `Очки: ${score}`;
            }
        }

        // Анимация
        let lastFrame = performance.now();
        function animate() {
            const now = performance.now();
            const delta = (now - lastFrame) / 1000; // Дельта времени для плавности
            lastFrame = now;

            if (health <= 0) {
                gameOverElement.style.display = 'flex';
                return;
            }
            requestAnimationFrame(animate);

            // Обновление врагов
            enemies.forEach((enemy, index) => {
                const direction = camera.position.clone().sub(enemy.position).normalize();
                enemy.position.add(direction.multiplyScalar(0.05 * delta * 60));
                if (enemy.position.distanceTo(camera.position) < 1) {
                    scene.remove(enemy);
                    enemies.splice(index, 1);
                    health -= 5;
                    healthElement.textContent = `Здоровье: ${health}`;
                }
            });

            // Обновление пуль
            bullets.forEach((bullet, bIndex) => {
                bullet.position.add(bullet.velocity.clone().multiplyScalar(delta * 60));
                enemies.forEach((enemy, eIndex) => {
                    if (bullet.position.distanceTo(enemy.position) < 1) {
                        scene.remove(enemy);
                        enemies.splice(eIndex, 1);
                        scene.remove(bullet);
                        bullets.splice(bIndex, 1);
                        score += 10 * damageMultiplier;
                        scoreElement.textContent = `Очки: ${score}`;
                    }
                });
                if (bullet.position.distanceTo(camera.position) > 50) {
                    scene.remove(bullet);
                    bullets.splice(bIndex, 1);
                }
            });

            // Регенерация здоровья
            if (regenRate > 0) {
                health = Math.min(health + regenRate * delta, 100 + (regenRate > 0 ? 50 : 0));
                healthElement.textContent = `Здоровье: ${health}`;
            }

            // Обновление фонарика для ночи
            if (spotLight) {
                spotLight.position.copy(camera.position);
                spotLight.target.position.copy(camera.position).add(camera.getWorldDirection(new THREE.Vector3()));
                spotLight.target.updateMatrixWorld();
            }

            renderer.render(scene, camera);
        }

        // Адаптация размера
        window.addEventListener('resize', () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        });
    </script>
</body>
</html>
