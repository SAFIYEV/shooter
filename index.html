<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–û–ø–µ—Ä–∞—Ü–∏—è: –®—Ç–æ—Ä–º - –ú–æ–±–∏–ª—å–Ω—ã–π FPS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Arial', sans-serif; 
            overflow: hidden; 
            background: #0a0a0a;
            touch-action: none;
            user-select: none;
        }
        
        canvas { display: block; width: 100vw; height: 100vh; }
        
        /* –ú–µ–Ω—é —Å—Ç–∏–ª–∏ */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a2a1a, #0f1f0f);
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .screen h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            color: #4CAF50;
        }
        
        .btn {
            padding: 15px 30px;
            margin: 10px;
            font-size: 18px;
            background: linear-gradient(45deg, #2E7D32, #388E3C);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn:hover { background: linear-gradient(45deg, #388E3C, #43A047); }
        .btn:active { transform: scale(0.95); }
        
        /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .hud {
            position: absolute;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 50;
        }
        
        #score { top: 10px; left: 10px; font-size: 18px; }
        #health { top: 35px; left: 10px; font-size: 18px; }
        #ammo { top: 60px; left: 10px; font-size: 18px; }
        #crosshair { 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #4CAF50;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã */
        .mobile-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 60;
        }
        
        .shoot-btn {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, #f44336, #d32f2f);
            border: 3px solid #fff;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
        }
        
        .shoot-btn:active { transform: scale(0.9); }
        
        .joystick-zone {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: 120px;
            z-index: 60;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (orientation: portrait) {
            .portrait-warning {
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: #000;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                text-align: center;
                z-index: 1000;
            }
        }
        
        @media (orientation: landscape) {
            .portrait-warning { display: none !important; }
        }
        
        .content {
            max-width: 90%;
            max-height: 70%;
            overflow-y: auto;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #4CAF50;
        }
        
        .task-item, .shop-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(46, 125, 50, 0.2);
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="portrait-warning">
        üîÑ –ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –¥–ª—è –ª—É—á—à–µ–≥–æ –∏–≥—Ä–æ–≤–æ–≥–æ –æ–ø—ã—Ç–∞
    </div>

    <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
    <div id="mainMenu" class="screen">
        <h1>üéØ –û–ü–ï–†–ê–¶–ò–Ø: –®–¢–û–†–ú</h1>
        <button class="btn" onclick="game.showGameModes()">üéÆ –ò–ì–†–ê–¢–¨</button>
        <button class="btn" onclick="game.showTasks()">üìã –ó–ê–î–ê–ù–ò–Ø</button>
        <button class="btn" onclick="game.showShop()">üõí –ú–ê–ì–ê–ó–ò–ù</button>
        <button class="btn" onclick="game.showStats()">üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê</button>
    </div>

    <!-- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã -->
    <div id="gameModes" class="screen" style="display: none;">
        <h1>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫</h1>
        <button class="btn" onclick="game.startGame('day')">‚òÄÔ∏è –î–ï–ù–¨</button>
        <button class="btn" onclick="game.startGame('night')">üåô –ù–û–ß–¨</button>
        <button class="btn" onclick="game.showMain()">‚¨ÖÔ∏è –ù–ê–ó–ê–î</button>
    </div>

    <!-- –ó–∞–¥–∞–Ω–∏—è -->
    <div id="tasksMenu" class="screen" style="display: none;">
        <h1>üìã –ë–æ–µ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è</h1>
        <div class="content" id="tasksList"></div>
        <button class="btn" onclick="game.showMain()">‚¨ÖÔ∏è –ù–ê–ó–ê–î</button>
    </div>

    <!-- –ú–∞–≥–∞–∑–∏–Ω -->
    <div id="shopMenu" class="screen" style="display: none;">
        <h1>üõí –í–æ–µ–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω</h1>
        <div class="content" id="shopList"></div>
        <button class="btn" onclick="game.showMain()">‚¨ÖÔ∏è –ù–ê–ó–ê–î</button>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="statsMenu" class="screen" style="display: none;">
        <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ–π—Ü–∞</h1>
        <div class="content" id="statsList"></div>
        <button class="btn" onclick="game.showMain()">‚¨ÖÔ∏è –ù–ê–ó–ê–î</button>
    </div>

    <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
    <div id="gameScreen" style="display: none;">
        <div id="score" class="hud">–û—á–∫–∏: 0</div>
        <div id="health" class="hud">‚ù§Ô∏è 100</div>
        <div id="ammo" class="hud">üî´ 30/90</div>
        <div id="crosshair" class="hud">‚äï</div>
        
        <div class="joystick-zone" id="joystickZone"></div>
        <div class="mobile-controls">
            <button class="shoot-btn" id="shootBtn">–û–ì–û–ù–¨</button>
        </div>
    </div>

    <!-- Game Over -->
    <div id="gameOver" class="screen" style="display: none;">
        <h1>‚ò†Ô∏è –ú–ò–°–°–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê</h1>
        <div id="finalStats" style="margin: 20px 0; font-size: 18px;"></div>
        <button class="btn" onclick="game.showMain()">üè† –í –ú–ï–ù–Æ</button>
        <button class="btn" onclick="game.restartGame()">üîÑ –ü–û–í–¢–û–†–ò–¢–¨</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // –ì–ª–∞–≤–Ω—ã–π –∏–≥—Ä–æ–≤–æ–π –∫–ª–∞—Å—Å
        class FPSGame {
            constructor() {
                this.init();
                this.loadData();
                this.setupEventListeners();
            }

            init() {
                // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                this.score = 0;
                this.health = 100;
                this.maxHealth = 100;
                this.ammo = 30;
                this.maxAmmo = 30;
                this.reserveAmmo = 90;
                this.enemiesKilled = 0;
                this.gameTime = 0;
                this.gameStartTime = 0;
                this.isPlaying = false;
                this.timeOfDay = 'day';
                
                // –£–ª—É—á—à–µ–Ω–∏—è
                this.upgrades = {
                    extraHealth: 0,
                    regeneration: false,
                    damageBoost: false,
                    ammoCapacity: false
                };

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                this.stats = {
                    totalKills: 0,
                    totalScore: 0,
                    gamesPlayed: 0,
                    bestScore: 0,
                    totalPlayTime: 0
                };

                // –ó–∞–¥–∞–Ω–∏—è
                this.tasks = [
                    { id: 1, desc: "–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å 10 –≤—Ä–∞–≥–æ–≤", target: 10, type: 'kills', reward: 50, completed: false },
                    { id: 2, desc: "–ù–∞–±—Ä–∞—Ç—å 100 –æ—á–∫–æ–≤", target: 100, type: 'score', reward: 75, completed: false },
                    { id: 3, desc: "–í—ã–∂–∏—Ç—å 60 —Å–µ–∫—É–Ω–¥", target: 60, type: 'survival', reward: 100, completed: false },
                    { id: 4, desc: "–£–±–∏—Ç—å 5 –≤—Ä–∞–≥–æ–≤ –∑–∞ 30 —Å–µ–∫—É–Ω–¥", target: 5, type: 'speed_kill', reward: 125, completed: false },
                    { id: 5, desc: "–ù–∞–±—Ä–∞—Ç—å 500 –æ—á–∫–æ–≤", target: 500, type: 'score', reward: 200, completed: false }
                ];

                this.initThreeJS();
                this.setupControls();
                this.updateUI();
            }

            initThreeJS() {
                // –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Three.js
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setClearColor(0x87CEEB);
                document.body.appendChild(this.renderer.domElement);

                // –ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞
                this.camera.position.y = 1.7;
                this.camera.rotation.order = 'YXZ';

                // –°–æ–∑–¥–∞–Ω–∏–µ –º–∏—Ä–∞
                this.createWorld();
                this.createWeapon();
                
                // –ú–∞—Å—Å–∏–≤—ã –¥–ª—è –∏–≥—Ä–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
                this.enemies = [];
                this.bullets = [];
                this.particles = [];

                // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                this.keys = {};
                this.mouse = { x: 0, y: 0 };
                this.velocity = new THREE.Vector3();
                this.yaw = 0;
                this.pitch = 0;
            }

            createWorld() {
                // –ü–æ–ª
                const groundGeometry = new THREE.PlaneGeometry(200, 200);
                const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x228B22 });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                this.scene.add(ground);

                // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
                for (let i = 0; i < 20; i++) {
                    const boxGeometry = new THREE.BoxGeometry(
                        Math.random() * 3 + 1,
                        Math.random() * 4 + 1,
                        Math.random() * 3 + 1
                    );
                    const boxMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
                    const box = new THREE.Mesh(boxGeometry, boxMaterial);
                    box.position.set(
                        (Math.random() - 0.5) * 100,
                        box.geometry.parameters.height / 2,
                        (Math.random() - 0.5) * 100
                    );
                    this.scene.add(box);
                }
            }

            createWeapon() {
                // –ü—Ä–æ—Å—Ç–æ–µ –æ—Ä—É–∂–∏–µ
                const weaponGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.8);
                const weaponMaterial = new THREE.MeshBasicMaterial({ color: 0x333333 });
                this.weapon = new THREE.Mesh(weaponGeometry, weaponMaterial);
                this.weapon.position.set(0.3, -0.3, -0.5);
                this.camera.add(this.weapon);
                this.scene.add(this.camera);
            }

            setLighting(timeOfDay) {
                // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
                this.scene.children = this.scene.children.filter(child => 
                    !(child instanceof THREE.Light)
                );

                if (timeOfDay === 'day') {
                    this.renderer.setClearColor(0x87CEEB);
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(50, 50, 25);
                    this.scene.add(ambientLight, directionalLight);
                } else {
                    this.renderer.setClearColor(0x191970);
                    const ambientLight = new THREE.AmbientLight(0x404040, 0.2);
                    const spotLight = new THREE.SpotLight(0xffffff, 1);
                    spotLight.position.copy(this.camera.position);
                    spotLight.target.position.copy(this.camera.position).add(this.camera.getWorldDirection(new THREE.Vector3()));
                    this.scene.add(ambientLight, spotLight);
                    this.flashlight = spotLight;
                }
            }

            setupControls() {
                // –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥–∂–æ–π—Å—Ç–∏–∫
                this.joystick = null;
                this.touchStart = { x: 0, y: 0 };
                this.touchCurrent = { x: 0, y: 0 };
                this.isTouching = false;

                // –ó–æ–Ω–∞ –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫–∞–º–µ—Ä—ã (–ø—Ä–∞–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ —ç–∫—Ä–∞–Ω–∞)
                this.lookZone = document.createElement('div');
                this.lookZone.style.position = 'absolute';
                this.lookZone.style.right = '0';
                this.lookZone.style.top = '0';
                this.lookZone.style.width = '60%';
                this.lookZone.style.height = '100%';
                this.lookZone.style.zIndex = '40';
                document.body.appendChild(this.lookZone);

                this.setupTouchControls();
            }

            setupTouchControls() {
                const joystickZone = document.getElementById('joystickZone');
                
                // –î–∂–æ–π—Å—Ç–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è
                joystickZone.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = joystickZone.getBoundingClientRect();
                    this.joystick = {
                        centerX: rect.left + rect.width / 2,
                        centerY: rect.top + rect.height / 2,
                        maxDistance: rect.width / 2
                    };
                    this.updateJoystick(touch.clientX, touch.clientY);
                });

                joystickZone.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (this.joystick) {
                        const touch = e.touches[0];
                        this.updateJoystick(touch.clientX, touch.clientY);
                    }
                });

                joystickZone.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.joystick = null;
                    this.velocity.multiplyScalar(0);
                });

                // –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞–º–µ—Ä—ã
                this.lookZone.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    this.touchStart.x = touch.clientX;
                    this.touchStart.y = touch.clientY;
                    this.isTouching = true;
                });

                this.lookZone.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (this.isTouching) {
                        const touch = e.touches[0];
                        const deltaX = touch.clientX - this.touchStart.x;
                        const deltaY = touch.clientY - this.touchStart.y;
                        
                        this.yaw -= deltaX * 0.002;
                        this.pitch -= deltaY * 0.002;
                        this.pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, this.pitch));
                        
                        this.touchStart.x = touch.clientX;
                        this.touchStart.y = touch.clientY;
                    }
                });

                this.lookZone.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.isTouching = false;
                });

                // –ö–Ω–æ–ø–∫–∞ —Å—Ç—Ä–µ–ª—å–±—ã
                document.getElementById('shootBtn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.shoot();
                });
            }

            updateJoystick(x, y) {
                if (!this.joystick) return;
                
                const deltaX = x - this.joystick.centerX;
                const deltaY = y - this.joystick.centerY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (distance > this.joystick.maxDistance) {
                    const angle = Math.atan2(deltaY, deltaX);
                    this.velocity.x = Math.cos(angle) * 0.1;
                    this.velocity.z = Math.sin(angle) * 0.1;
                } else {
                    const strength = distance / this.joystick.maxDistance;
                    this.velocity.x = (deltaX / this.joystick.maxDistance) * 0.1 * strength;
                    this.velocity.z = (deltaY / this.joystick.maxDistance) * 0.1 * strength;
                }
            }

            shoot() {
                if (this.ammo <= 0) {
                    this.reload();
                    return;
                }

                this.ammo--;
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª–∏
                const bulletGeometry = new THREE.SphereGeometry(0.05);
                const bulletMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
                const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
                
                bullet.position.copy(this.camera.position);
                const direction = new THREE.Vector3();
                this.camera.getWorldDirection(direction);
                bullet.velocity = direction.multiplyScalar(2);
                bullet.life = 100;
                
                this.scene.add(bullet);
                this.bullets.push(bullet);

                // –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–¥–∞—á–∏ –æ—Ä—É–∂–∏—è
                this.weapon.position.z -= 0.1;
                setTimeout(() => {
                    this.weapon.position.z += 0.1;
                }, 100);

                this.updateAmmoDisplay();
            }

            reload() {
                if (this.reserveAmmo <= 0) return;
                
                const ammoNeeded = this.maxAmmo - this.ammo;
                const ammoToReload = Math.min(ammoNeeded, this.reserveAmmo);
                
                this.ammo += ammoToReload;
                this.reserveAmmo -= ammoToReload;
                
                this.updateAmmoDisplay();
            }

            spawnEnemy() {
                const enemyGeometry = new THREE.BoxGeometry(1, 2, 1);
                const enemyMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
                const enemy = new THREE.Mesh(enemyGeometry, enemyMaterial);
                
                const angle = Math.random() * Math.PI * 2;
                const distance = 30 + Math.random() * 20;
                enemy.position.set(
                    Math.cos(angle) * distance,
                    1,
                    Math.sin(angle) * distance
                );
                
                enemy.health = 1;
                enemy.speed = 0.02 + Math.random() * 0.01;
                
                this.scene.add(enemy);
                this.enemies.push(enemy);
            }

            updateGame() {
                if (!this.isPlaying) return;

                const currentTime = Date.now();
                this.gameTime = (currentTime - this.gameStartTime) / 1000;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
                this.updatePlayer();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
                this.updateEnemies();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É–ª—å
                this.updateBullets();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
                this.camera.rotation.y = this.yaw;
                this.camera.rotation.x = this.pitch;
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ–Ω–∞—Ä–∏–∫–∞ –¥–ª—è –Ω–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
                if (this.flashlight) {
                    this.flashlight.position.copy(this.camera.position);
                    this.flashlight.target.position.copy(this.camera.position).add(this.camera.getWorldDirection(new THREE.Vector3()));
                    this.flashlight.target.updateMatrixWorld();
                }

                // –°–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤
                if (Math.random() < 0.01) {
                    this.spawnEnemy();
                }

                // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–¥–æ—Ä–æ–≤—å—è
                if (this.upgrades.regeneration && this.health < this.maxHealth) {
                    this.health = Math.min(this.maxHealth, this.health + 0.2);
                    this.updateHealthDisplay();
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏–π
                this.checkTasks();
                
                this.updateUI();
            }

            updatePlayer() {
                if (this.velocity.length() > 0) {
                    const forward = new THREE.Vector3();
                    this.camera.getWorldDirection(forward);
                    forward.y = 0;
                    forward.normalize();
                    
                    const right = new THREE.Vector3();
                    right.crossVectors(forward, new THREE.Vector3(0, 1, 0));
                    
                    const movement = new THREE.Vector3();
                    movement.addScaledVector(forward, -this.velocity.z);
                    movement.addScaledVector(right, this.velocity.x);
                    
                    this.camera.position.add(movement);
                }
            }

            updateEnemies() {
                this.enemies.forEach((enemy, index) => {
                    const direction = new THREE.Vector3()
                        .subVectors(this.camera.position, enemy.position)
                        .normalize();
                    
                    enemy.position.add(direction.multiplyScalar(enemy.speed));
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∏–≥—Ä–æ–∫–æ–º
                    if (enemy.position.distanceTo(this.camera.position) < 2) {
                        this.takeDamage(10);
                        this.scene.remove(enemy);
                        this.enemies.splice(index, 1);
                    }
                });
            }

            updateBullets() {
                this.bullets.forEach((bullet, bulletIndex) => {
                    bullet.position.add(bullet.velocity);
                    bullet.life--;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –ø–æ –≤—Ä–∞–≥–∞–º
                    this.enemies.forEach((enemy, enemyIndex) => {
                        if (bullet.position.distanceTo(enemy.position) < 1) {
                            // –ü–æ–ø–∞–¥–∞–Ω–∏–µ!
                            this.createHitEffect(enemy.position);
                            this.scene.remove(enemy);
                            this.enemies.splice(enemyIndex, 1);
                            this.scene.remove(bullet);
                            this.bullets.splice(bulletIndex, 1);
                            
                            this.enemiesKilled++;
                            this.score += 10 * (this.upgrades.damageBoost ? 1.5 : 1);
                            this.updateScoreDisplay();
                        }
                    });
                    
                    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—É–ª–∏ –µ—Å–ª–∏ –æ–Ω–∞ —É–ª–µ—Ç–µ–ª–∞ –¥–∞–ª–µ–∫–æ
                    if (bullet.life <= 0 || bullet.position.distanceTo(this.camera.position) > 100) {
                        this.scene.remove(bullet);
                        this.bullets.splice(bulletIndex, 1);
                    }
                });
            }

            createHitEffect(position) {
                const particleCount = 10;
                for (let i = 0; i < particleCount; i++) {
                    const particle = new THREE.Mesh(
                        new THREE.SphereGeometry(0.05),
                        new THREE.MeshBasicMaterial({ color: 0xff4444 })
                    );
                    particle.position.copy(position);
                    particle.velocity = new THREE.Vector3(
                        (Math.random() - 0.5) * 0.3,
                        Math.random() * 0.3,
                        (Math.random() - 0.5) * 0.3
                    );
                    particle.life = 30;
                    this.scene.add(particle);
                    this.particles.push(particle);
                }
            }

            takeDamage(amount) {
                this.health -= amount;
                if (this.health <= 0) {
                    this.gameOver();
                }
                this.updateHealthDisplay();
            }

            checkTasks() {
                this.tasks.forEach(task => {
                    if (task.completed) return;
                    
                    let progress = 0;
                    switch (task.type) {
                        case 'kills':
                            progress = this.enemiesKilled;
                            break;
                        case 'score':
                            progress = this.score;
                            break;
                        case 'survival':
                            progress = this.gameTime;
                            break;
                    }
                    
                    if (progress >= task.target) {
                        task.completed = true;
                        this.score += task.reward;
                        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è
                    }
                });
            }

            // UI –º–µ—Ç–æ–¥—ã
            updateUI() {
                this.updateScoreDisplay();
                this.updateHealthDisplay();
                this.updateAmmoDisplay();
            }

            updateScoreDisplay() {
                document.getElementById('score').textContent = `–û—á–∫–∏: ${this.score}`;
            }

            updateHealthDisplay() {
                document.getElementById('health').textContent = `‚ù§Ô∏è ${Math.max(0, Math.ceil(this.health))}`;
            }

            updateAmmoDisplay() {
                document.getElementById('ammo').textContent = `üî´ ${this.ammo}/${this.reserveAmmo}`;
            }

            // –ú–µ—Ç–æ–¥—ã —ç–∫—Ä–∞–Ω–æ–≤
            showMain() {
                this.hideAllScreens();
                document.getElementById('mainMenu').style.display = 'flex';
                if (this.isPlaying) {
                    this.stopGame();
                }
            }

            showGameModes() {
                this.hideAllScreens();
                document.getElementById('gameModes').style.display = 'flex';
            }

            showTasks() {
                this.hideAllScreens();
                document.getElementById('tasksMenu').style.display = 'flex';
                this.populateTasksList();
            }

            showShop() {
                this.hideAllScreens();
                document.getElementById('shopMenu').style.display = 'flex';
                this.populateShopList();
            }

            showStats() {
                this.hideAllScreens();
                document.getElementById('statsMenu').style.display = 'flex';
                this.populateStatsList();
            }

            hideAllScreens() {
                const screens = ['mainMenu', 'gameModes', 'tasksMenu', 'shopMenu', 'statsMenu', 'gameScreen', 'gameOver'];
                screens.forEach(id => {
                    document.getElementById(id).style.display = 'none';
                });
            }

            populateTasksList() {
                const container = document.getElementById('tasksList');
                container.innerHTML = '';
                
                this.tasks.forEach(task => {
                    const div = document.createElement('div');
                    div.className = 'task-item';
                    div.innerHTML = `
                        <strong>${task.desc}</strong><br>
                        –ù–∞–≥—Ä–∞–¥–∞: ${task.reward} –æ—á–∫–æ–≤<br>
                        –°—Ç–∞—Ç—É—Å: ${task.completed ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ'}
                    `;
                    container.appendChild(div);
                });
            }

            populateShopList() {
                const container = document.getElementById('shopList');
                container.innerHTML = '';
                
                const items = [
                    { name: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ (+50 HP)', cost: 100, upgrade: 'extraHealth'
