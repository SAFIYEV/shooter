<!DOCTYPE html>
<html>
<head>
    <title>Операция: Шторм (Мобильный Шутер)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Impact&display=swap');

        body { 
            margin: 0; 
            overflow: hidden; 
            background: #1a2a1a; 
            touch-action: none; /* Отключаем стандартные жесты браузера */
            font-family: 'Impact', Arial, sans-serif; /* Применяем Impact по умолчанию */
            color: #b8c2b8; /* Общий цвет текста */
        }
        canvas { 
            display: block; 
            width: 100vw; 
            height: 100vh; 
        }
        #menu, #tasks, #shop { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(34, 51, 34, 0.85); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            z-index: 10; 
            padding: 20px;
            box-sizing: border-box;
        }
        #menu h1, #tasks h1, #shop h1, #gameOver h1 {
            color: #d4e0d4;
            font-size: clamp(2.5em, 8vw, 4em); /* Адаптивный размер заголовков */
            margin-bottom: 25px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }
        #menu button, #tasks button, #shop button { 
            padding: 12px 25px; 
            margin: 10px; 
            font-size: clamp(1em, 4vw, 1.5em); /* Адаптивный размер кнопок */
            background: linear-gradient(45deg, #3c4f3c, #2a3b2a); 
            color: #b8c2b8; 
            border: 1px solid #4b704b; 
            border-radius: 6px; 
            cursor: pointer; 
            text-transform: uppercase; 
            transition: transform 0.1s ease, background 0.2s ease, box-shadow 0.2s ease; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            min-width: 180px; /* Минимальная ширина для кнопок */
        }
        #menu button:active, #tasks button:active, #shop button:active { 
            transform: scale(0.95); 
            background: linear-gradient(45deg, #4b704b, #3c4f3c); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.6);
        }
        #tasks div, #shop div { 
            max-height: 60%; 
            overflow-y: auto; 
            width: 90%; 
            max-width: 600px;
            font-size: clamp(0.9em, 3.5vw, 1.2em); /* Адаптивный размер текста */
            padding: 15px; 
            background: rgba(42, 59, 42, 0.9); 
            border: 1px solid #4b704b; 
            border-radius: 8px; 
            margin-bottom: 20px;
            text-align: left;
            line-height: 1.5;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        #tasks p, #shop p {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #shop p button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: clamp(0.8em, 3vw, 1em);
            min-width: unset;
            box-shadow: none;
        }
        #shop p button:active {
            box-shadow: none;
        }

        /* Игровой HUD */
        #score, #health { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            color: #d4e0d4; 
            font-size: clamp(1em, 3.5vw, 1.5em); /* Адаптивный размер */
            text-shadow: 2px 2px 4px #000; 
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 5px;
        }
        #health { 
            top: 45px; 
        }
        #crosshair { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            color: #d4e0d4; 
            font-size: clamp(1.5em, 5vw, 2.5em); /* Адаптивный размер */
            text-shadow: 1px 1px 2px #000; 
            pointer-events: none; /* Чтобы не мешал касаниям */
        }
        #shootBtn { 
            position: absolute; 
            bottom: 20px; 
            right: 20px; 
            width: clamp(60px, 15vw, 80px); 
            height: clamp(60px, 15vw, 80px); 
            background: linear-gradient(45deg, #ff5555, #cc0000); 
            border: 2px solid #b30000; 
            border-radius: 50%; 
            color: #fff; 
            font-size: clamp(1.2em, 3.5vw, 1.5em); 
            text-transform: uppercase; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: transform 0.1s ease, box-shadow 0.1s ease; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.6);
            z-index: 5; /* Над джойстиком */
        }
        #shootBtn:active { 
            transform: scale(0.9); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }

        #gameOver { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(34, 51, 34, 0.95); 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 10; 
        }
        #gameOver h1 {
            color: #ff5555; /* Красный для провала */
        }

        /* Сообщение о горизонтальной ориентации */
        @media (orientation: portrait) {
            body::before {
                content: "Пожалуйста, поверните устройство горизонтально для игры.";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #1a2a1a;
                color: #b8c2b8;
                font-family: 'Impact', Arial, sans-serif;
                font-size: clamp(1.2em, 5vw, 2em);
                padding: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                z-index: 1000;
            }
            canvas, #menu, #tasks, #shop, #score, #health, #crosshair, #shootBtn, #gameOver { 
                display: none !important; /* Важно, чтобы перекрывало JS display */
            }
        }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Операция: Шторм</h1>
        <button onclick="startGame('day')">Играть (День)</button>
        <button onclick="startGame('night')">Играть (Ночь)</button>
        <button onclick="showTasks()">Задания</button>
        <button onclick="showShop()">Магазин</button>
    </div>
    <div id="tasks" style="display: none;">
        <h1>Задания</h1>
        <div>
            <p>1. Убить 10 врагов (Награда: 50 очков)</p>
            <p>2. Набрать 100 очков (Награда: 100 очков)</p>
            <p>3. Выжить 1 минуту (Награда: 200 очков)</p>
            <p>4. Убить 5 врагов за 30 секунд (Награда: 150 очков)</p>
            <p>5. Достигнуть 500 очков (Награда: 300 очков)</p>
            <p>6. Убить 20 врагов (Награда: 100 очков)</p>
            <p>7. Выжить без урона 30 секунд (Награда: 200 очков)</p>
            <p>8. Убить врага с 20 метров (Награда: 150 очков)</p>
            <p>9. Набрать 1000 очков (Награда: 500 очков)</p>
            <p>10. Убить 3 врагов подряд (Награда: 100 очков)</p>
            <p>11. Выжить 2 минуты (Награда: 400 очков)</p>
            <p>12. Убить 50 врагов (Награда: 300 очков)</p>
            <p>13. Набрать 200 очков за 1 минуту (Награда: 250 очков)</p>
            <p>14. Убить 10 врагов без урона (Награда: 200 очков)</p>
            <p>15. Достигнуть 2000 очков (Награда: 1000 очков)</p>
            <p>16. Убить врага с 30 метров (Награда: 200 очков)</p>
            <p>17. Выжить 3 минуты (Награда: 600 очков)</p>
            <p>18. Убить 5 врагов за 20 секунд (Награда: 200 очков)</p>
            <p>19. Набрать 500 очков без урона (Награда: 400 очков)</p>
            <p>20. Убить 100 врагов (Награда: 1000 очков)</p>
        </div>
        <button onclick="showMenu()">Назад</button>
    </div>
    <div id="shop" style="display: none;">
        <h1>Магазин</h1>
        <div>
            <p>Доп. здоровье (+50 HP) - 100 очков <button onclick="buyHealth()">Купить</button></p>
            <p>Регенерация (+1 HP/сек) - 200 очков <button onclick="buyRegen()">Купить</button></p>
            <p>Увеличенный урон (+50%) - 150 очков <button onclick="buyDamage()">Купить</button></p>
        </div>
        <button onclick="showMenu()">Назад</button>
    </div>
    <div id="score" style="display: none;">Очки: 0</div>
    <div id="health" style="display: none;">Здоровье: 100</div>
    <div id="crosshair" style="display: none;">+</div>
    <button id="shootBtn" style="display: none;">Огонь</button>
    <div id="gameOver" style="display: none;">
        <h1>Миссия провалена</h1>
        <button onclick="showMenu()">Вернуться в меню</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.10.0/dist/nipplejs.min.js"></script>
    <script>
        // Зафиксировать горизонтальную ориентацию и показать сообщение
        function checkOrientation() {
            if (window.innerHeight > window.innerWidth) {
                document.body.classList.add('portrait');
            } else {
                document.body.classList.remove('portrait');
            }
        }
        window.addEventListener('resize', checkOrientation);
        checkOrientation(); // Проверить при загрузке

        // Three.js Scene Setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        // Ground (Grass-like)
        const groundGeometry = new THREE.PlaneGeometry(100, 100);
        const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x4a6d4a }); // Использовать LambertMaterial для реакции на свет
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true; // Пол может получать тени
        scene.add(ground);

        // Lighting
        let ambientLight, spotLight;
        function setTimeOfDay(time) {
            // Удаляем старые источники света, если они есть
            if (ambientLight) scene.remove(ambientLight);
            if (spotLight) {
                scene.remove(spotLight);
                scene.remove(spotLight.target); // Удаляем цель фонаря
            }

            if (time === 'day') {
                ambientLight = new THREE.AmbientLight(0xffffff, 0.8); // Яркий дневной свет
                scene.add(ambientLight);
            } else { // Night
                ambientLight = new THREE.AmbientLight(0x222222, 0.2); // Очень тусклый фоновый свет
                scene.add(ambientLight);

                spotLight = new THREE.SpotLight(0xffffff, 1.0); // Яркий фонарик
                spotLight.angle = Math.PI / 8; // Узкий конус
                spotLight.penumbra = 0.7; // Мягкие края
                spotLight.distance = 40; // Дальность свечения
                spotLight.decay = 2; // Более реалистичное затухание
                spotLight.castShadow = true; // Фонарик отбрасывает тени
                spotLight.shadow.mapSize.width = 1024;
                spotLight.shadow.mapSize.height = 1024;
                spotLight.shadow.camera.near = 0.5;
                spotLight.shadow.camera.far = 50;

                scene.add(spotLight);
                // Цель фонарика будет обновляться в animate()
                spotLight.target = new THREE.Object3D(); // Создаем объект-цель
                scene.add(spotLight.target);
            }
        }

        // Weapon (simplified)
        const weaponGroup = new THREE.Group(); // Группа для оружия, чтобы легче позиционировать и анимировать
        const weaponMaterial = new THREE.MeshLambertMaterial({ color: 0x4b704b });

        const mainBarrel = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.07, 0.5), weaponMaterial);
        mainBarrel.position.set(0, 0, -0.2);
        weaponGroup.add(mainBarrel);

        const handle = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.15, 0.1), weaponMaterial);
        handle.position.set(0, -0.1, 0.15);
        weaponGroup.add(handle);

        weaponGroup.position.set(0.3, -0.3, -0.5); // Позиционируем оружие относительно камеры
        camera.add(weaponGroup);
        scene.add(camera); // Добавляем камеру со встроенным оружием в сцену

        // Player State
        camera.position.y = 1.6;
        let moveDirection = new THREE.Vector3(); // Направление движения игрока
        let yaw = 0; // Вращение по горизонтали
        let health = 100;
        let regenRate = 0; // HP/сек
        let damageMultiplier = 1;
        let score = 0;
        let enemySpawnInterval; // Для хранения setInterval ID

        // UI Elements
        const scoreElement = document.getElementById('score');
        const healthElement = document.getElementById('health');
        const gameOverElement = document.getElementById('gameOver');
        const shootBtn = document.getElementById('shootBtn');

        // Control Variables
        let moveJoystick, touchZone;
        let isShooting = false; // Флаг для удержания кнопки выстрела
        let shootCooldown = 200; // Миллисекунды между выстрелами
        let lastShotTime = 0;

        function setupControls() {
            // Удаляем старые джойстики и зоны, если они были
            if (moveJoystick) moveJoystick.destroy();
            if (touchZone) touchZone.remove();

            // Joystick for Movement
            moveJoystick = nipplejs.create({
                zone: document.body,
                position: { left: '15%', bottom: '15%' }, // Немного сдвинуто
                mode: 'static',
                size: window.innerWidth * 0.25, // Адаптивный размер
                color: 'white',
                threshold: 0.1, // Мёртвая зона
                fadeTime: 0,
                restOpacity: 0.7,
                lockX: false,
                lockY: false
            });

            moveJoystick.on('move', (evt, data) => {
                const angleRad = data.angle.radian;
                const force = Math.min(data.force, 1);
                
                // Рассчитываем направление движения относительно камеры
                const forward = new THREE.Vector3();
                camera.getWorldDirection(forward);
                forward.y = 0; // Игнорируем вертикальную составляющую
                forward.normalize();

                const right = new THREE.Vector3().crossVectors(camera.up, forward); // Вектор вправо

                moveDirection.set(0, 0, 0);

                if (force > 0.1) {
                    // Используем угол джойстика для определения направления
                    // 0 градусов (вправо) = движение вперед+вправо, 90 (вверх) = вперед
                    const xComponent = Math.cos(angleRad);
                    const zComponent = Math.sin(angleRad);

                    moveDirection.addScaledVector(forward, zComponent); // Вперед/назад
                    moveDirection.addScaledVector(right, xComponent); // Вправо/влево
                    moveDirection.normalize().multiplyScalar(force * 0.08); // Скорость движения
                }
            }).on('end', () => {
                moveDirection.set(0, 0, 0); // Обнуляем движение при отпускании
            });

            // Touch zone for Camera Look (Right half of screen)
            touchZone = document.createElement('div');
            touchZone.style.position = 'absolute';
            touchZone.style.right = '0';
            touchZone.style.top = '0';
            touchZone.style.width = '50%';
            touchZone.style.height = '100%';
            touchZone.style.zIndex = '1'; // Убедимся, что она ниже HUD элементов
            document.body.appendChild(touchZone);

            let touchStartX = null;
            let lastDeltaX = 0;
            let lastDeltaY = 0;

            touchZone.addEventListener('touchstart', (e) => {
                e.preventDefault();
                // Проверяем, что касание не на кнопке "Огонь"
                if (e.target !== shootBtn) {
                    touchStartX = e.touches[0].clientX;
                    lastDeltaX = 0;
                    lastDeltaY = 0;
                }
            }, { passive: false });

            touchZone.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (touchStartX !== null && e.target !== shootBtn) {
                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;

                    const deltaX = currentX - touchStartX;
                    const deltaY = currentY - (touchZone._lastY || currentY); // Для вертикального поворота

                    // Сглаживание движений для более плавного поворота
                    const smoothedDeltaX = lastDeltaX * 0.7 + deltaX * 0.3;
                    const smoothedDeltaY = lastDeltaY * 0.7 + deltaY * 0.3;

                    yaw -= smoothedDeltaX * 0.002; // Чувствительность горизонтального поворота
                    camera.rotation.set(0, yaw, 0); // Обновляем только Yaw (Y-ось)

                    // Для вертикального поворота (pitch)
                    // camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x - smoothedDeltaY * 0.002));

                    touchStartX = currentX;
                    touchZone._lastY = currentY;
                    lastDeltaX = smoothedDeltaX;
                    lastDeltaY = smoothedDeltaY;
                }
            }, { passive: false });

            touchZone.addEventListener('touchend', () => {
                touchStartX = null;
                lastDeltaX = 0;
                lastDeltaY = 0;
                delete touchZone._lastY;
            });
        }

        // Enemies
        const enemies = [];
        const enemySpeed = 0.03; // Скорость врагов
        function spawnEnemy() {
            const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
            const material = new THREE.MeshLambertMaterial({ color: 0xcc0000 }); // Красные враги
            const enemy = new THREE.Mesh(geometry, material);
            enemy.castShadow = true; // Враги отбрасывают тени

            // Спавн врагов на расстоянии от игрока
            const angle = Math.random() * Math.PI * 2;
            const distance = 15 + Math.random() * 10; // От 15 до 25 метров
            enemy.position.set(
                camera.position.x + Math.cos(angle) * distance,
                0.4, // Высота над землей
                camera.position.z + Math.sin(angle) * distance
            );
            scene.add(enemy);
            enemies.push(enemy);
        }

        // Bullets
        const bullets = [];
        function shoot() {
            const now = performance.now();
            if (now - lastShotTime < shootCooldown) return;

            lastShotTime = now;

            const geometry = new THREE.SphereGeometry(0.08, 8, 8);
            const material = new THREE.MeshBasicMaterial({ color: 0xffff00 }); // Желтая пуля
            const bullet = new THREE.Mesh(geometry, material);

            bullet.position.copy(camera.position); // Начальная позиция пули - камера
            // Немного смещаем пулю вперед, чтобы она не стартовала внутри игрока
            const cameraDirection = new THREE.Vector3();
            camera.getWorldDirection(cameraDirection);
            bullet.position.add(cameraDirection.multiplyScalar(0.5)); 

            bullet.velocity = cameraDirection.clone().multiplyScalar(0.8); // Скорость пули
            scene.add(bullet);
            bullets.push(bullet);

            // Weapon recoil animation
            weaponGroup.position.z -= 0.1;
            setTimeout(() => {
                weaponGroup.position.z += 0.1;
            }, 70); // Быстрый откат
        }

        // Handle shoot button press and hold
        shootBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isShooting = true;
            shoot(); // Выстрел сразу при касании
        }, { passive: false });

        shootBtn.addEventListener('touchend', () => {
            isShooting = false;
        });

        // Game State Variables
        let gameRunning = false;
        let lastFrameTime = performance.now();

        // Menu functions
        function showMenu() {
            document.getElementById('menu').style.display = 'flex';
            document.getElementById('tasks').style.display = 'none';
            document.getElementById('shop').style.display = 'none';
            document.getElementById('score').style.display = 'none';
            document.getElementById('health').style.display = 'none';
            document.getElementById('crosshair').style.display = 'none';
            document.getElementById('shootBtn').style.display = 'none';
            gameOverElement.style.display = 'none';

            gameRunning = false;
            clearInterval(enemySpawnInterval); // Останавливаем спавн врагов

            // Очищаем Three.js объекты
            enemies.forEach(enemy => scene.remove(enemy));
            enemies.length = 0;
            bullets.forEach(bullet => scene.remove(bullet));
            bullets.length = 0;

            // Удаляем элементы управления
            if (moveJoystick) {
                moveJoystick.destroy();
                moveJoystick = null;
            }
            if (touchZone) {
                touchZone.remove();
                touchZone = null;
            }

            // Сбрасываем свет
            if (ambientLight) scene.remove(ambientLight);
            if (spotLight) {
                scene.remove(spotLight);
                scene.remove(spotLight.target);
                spotLight = null;
            }
        }

        function showTasks() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('tasks').style.display = 'flex';
        }

        function showShop() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('shop').style.display = 'flex';
        }

        function startGame(time) {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('score').style.display = 'block';
            document.getElementById('health').style.display = 'block';
            document.getElementById('crosshair').style.display = 'block';
            document.getElementById('shootBtn').style.display = 'flex'; // Use flex for shoot button
            gameOverElement.style.display = 'none';

            health = 100;
            score = 0;
            regenRate = 0; // Сброс регенерации при новой игре
            damageMultiplier = 1; // Сброс множителя урона
            scoreElement.textContent = `Очки: ${score}`;
            healthElement.textContent = `Здоровье: ${health}`;

            setTimeOfDay(time);
            setupControls();

            // Reset camera position and rotation
            camera.position.set(0, 1.6, 0);
            yaw = 0;
            camera.rotation.set(0, yaw, 0);

            // Clear existing enemies and bullets
            enemies.forEach(enemy => scene.remove(enemy));
            enemies.length = 0;
            bullets.forEach(bullet => scene.remove(bullet));
            bullets.length = 0;

            enemySpawnInterval = setInterval(spawnEnemy, 3000); // Спавн врагов каждые 3 секунды
            gameRunning = true;
            animate(); // Запускаем игровой цикл
        }

        // Shop functions
        function buyHealth() {
            if (score >= 100) {
                score -= 100;
                health = Math.min(health + 50, 200); // Максимальное здоровье 200
                scoreElement.textContent = `Очки: ${score}`;
                healthElement.textContent = `Здоровье: ${health}`;
            } else {
                alert("Недостаточно очков!");
            }
        }

        function buyRegen() {
            if (score >= 200 && regenRate === 0) { // Купить только один раз
                score -= 200;
                regenRate = 5; // Увеличиваем регенерацию до 5 HP/сек
                scoreElement.textContent = `Очки: ${score}`;
                alert("Регенерация здоровья активирована!");
            } else if (regenRate > 0) {
                alert("Регенерация уже активна!");
            } else {
                alert("Недостаточно очков!");
            }
        }

        function buyDamage() {
            if (score >= 150 && damageMultiplier === 1) { // Купить только один раз
                score -= 150;
                damageMultiplier = 1.5; // Увеличение урона на 50%
                scoreElement.textContent = `Очки: ${score}`;
                alert("Урон увеличен на 50%!");
            } else if (damageMultiplier > 1) {
                alert("Урон уже увеличен!");
            } else {
                alert("Недостаточно очков!");
            }
        }

        // Game Loop
        function animate() {
            if (!gameRunning) return; // Останавливаем цикл, если игра не активна

            requestAnimationFrame(animate);

            const now = performance.now();
            const delta = (now - lastFrameTime) / 1000; // Delta time in seconds
            lastFrameTime = now;

            // Apply player movement
            if (moveDirection.lengthSq() > 0) {
                camera.position.addScaledVector(moveDirection, delta * 60); // Скорость * delta * 60 (для приведения к 60 FPS)
            }
            
            // Health regeneration
            if (regenRate > 0) {
                health = Math.min(health + regenRate * delta, 100 + (regenRate > 0 ? 50 : 0)); // Cap at 150 HP if regen is active
                healthElement.textContent = `Здоровье: ${Math.floor(health)}`;
            }

            // Auto-shoot if button is held down (with cooldown)
            if (isShooting) {
                shoot();
            }

            // Update enemies
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                const directionToPlayer = new THREE.Vector3().subVectors(camera.position, enemy.position).normalize();
                enemy.position.addScaledVector(directionToPlayer, enemySpeed * delta * 60); // Move towards player

                // Collision with player
                if (enemy.position.distanceTo(camera.position) < 1.2) { // Если враг вплотную к игроку
                    scene.remove(enemy);
                    enemies.splice(i, 1);
                    health -= 10; // Урон от врага
                    healthElement.textContent = `Здоровье: ${Math.floor(health)}`;
                    if (health <= 0) {
                        gameRunning = false;
                        gameOverElement.style.display = 'flex';
                        clearInterval(enemySpawnInterval);
                        if (moveJoystick) moveJoystick.destroy(); // Уничтожить джойстик при конце игры
                        if (touchZone) touchZone.remove();
                        return; // Остановить анимацию
                    }
                }
            }

            // Update bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.position.addScaledVector(bullet.velocity, delta * 60); // Move bullet

                let hitEnemy = false;
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    if (bullet.position.distanceTo(enemy.position) < 0.6) { // Bullet hits enemy
                        scene.remove(enemy);
                        enemies.splice(j, 1);
                        scene.remove(bullet);
                        bullets.splice(i, 1);
                        score += 10 * damageMultiplier; // Apply damage multiplier
                        scoreElement.textContent = `Очки: ${score}`;
                        hitEnemy = true;
                        break; // Bullet hit, no need to check other enemies
                    }
                }

                if (!hitEnemy && bullet.position.distanceTo(camera.position) > 50) { // Bullet out of range
                    scene.remove(bullet);
                    bullets.splice(i, 1);
                }
            }

            // Update flashlight for night mode
            if (spotLight) {
                spotLight.position.copy(camera.position);
                const targetDirection = new THREE.Vector3();
                camera.getWorldDirection(targetDirection);
                spotLight.target.position.copy(camera.position).add(targetDirection.multiplyScalar(10)); // Цель в 10 метрах впереди
                spotLight.target.updateMatrixWorld(); // Важно обновить матрицу мира цели
            }

            renderer.render(scene, camera);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            checkOrientation(); // Перепроверить ориентацию при изменении размера
        });

        // Show menu on initial load
        showMenu();
    </script>
</body>
</html>
